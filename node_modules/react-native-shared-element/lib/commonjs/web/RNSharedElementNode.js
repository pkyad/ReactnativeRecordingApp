var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.RNSharedElementNode=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _RNSharedElementStyle=require("./RNSharedElementStyle");var _RNSharedElementContent=require("./RNSharedElementContent");var _Rect=require("./Rect");var RNSharedElementNode=function(){function RNSharedElementNode(domNode,isParent,ancestorDomNode){(0,_classCallCheck2.default)(this,RNSharedElementNode);this.hideRefCount=0;this.hideOpacity=0;this.refCount=1;this.styleCache=null;this.styleCallbacks=null;this.contentCache=null;this.contentCallbacks=null;this.domNode=domNode;this.isParent=isParent;this.ancestorDomNode=ancestorDomNode;}(0,_createClass2.default)(RNSharedElementNode,[{key:"addRef",value:function addRef(){return++this.refCount;}},{key:"releaseRef",value:function releaseRef(){return--this.refCount;}},{key:"addHideRef",value:function addHideRef(){this.hideRefCount++;if(this.hideRefCount===1){var element=this.resolvedElement;this.hideOpacity=element.style.opacity;element.style.opacity=0;}}},{key:"releaseHideRef",value:function releaseHideRef(){this.hideRefCount--;if(this.hideRefCount===0){var element=this.resolvedElement;element.style.opacity=this.hideOpacity;}}},{key:"requestStyle",value:function requestStyle(){var _this=this;if(this.styleCache){return Promise.resolve(this.styleCache);}return new Promise(function(resolve){_this.styleCallbacks=_this.styleCallbacks||[];_this.styleCallbacks.push(resolve);if(!_this.fetchInitialStyle()){console.debug('Failed to fetch style');}});}},{key:"fetchInitialStyle",value:function fetchInitialStyle(){var element=this.resolvedElement;var ancestor=this.resolvedAncestor;if(!element||!ancestor)return false;if(!this.styleCallbacks)return true;var rect=element.getBoundingClientRect();var ancestorRect=ancestor.getBoundingClientRect();var translateX=ancestorRect.x;var translateY=ancestorRect.y;var layout=new _Rect.Rect({x:rect.x-translateX,y:rect.y-translateY,width:rect.width,height:rect.height});var style=new _RNSharedElementStyle.RNSharedElementStyle(layout,window.getComputedStyle(element,null));this.styleCache=style;var callbacks=this.styleCallbacks;this.styleCallbacks=null;callbacks.forEach(function(callback){return callback(style);});return true;}},{key:"requestContent",value:function requestContent(){var _this2=this;return _regenerator.default.async(function requestContent$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!this.contentCache){_context.next=2;break;}return _context.abrupt("return",this.contentCache);case 2:return _context.abrupt("return",new Promise(function(resolve){if(_this2.contentCallbacks)return;_this2.contentCallbacks=_this2.contentCallbacks||[];_this2.contentCallbacks.push(resolve);_this2.fetchInitialContent();}));case 3:case"end":return _context.stop();}}},null,this);}},{key:"fetchInitialContent",value:function fetchInitialContent(){var element,size,content,callbacks;return _regenerator.default.async(function fetchInitialContent$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:element=this.resolvedElement;if(element){_context2.next=3;break;}return _context2.abrupt("return",false);case 3:if(this.contentCallbacks){_context2.next=5;break;}return _context2.abrupt("return",true);case 5:_context2.next=7;return _regenerator.default.awrap(_RNSharedElementContent.RNSharedElementContent.getSize(element));case 7:size=_context2.sent;if(size){_context2.next=10;break;}return _context2.abrupt("return",false);case 10:content=new _RNSharedElementContent.RNSharedElementContent(element,size);this.contentCache=content;callbacks=this.contentCallbacks;this.contentCallbacks=null;callbacks.forEach(function(callback){return callback(content);});return _context2.abrupt("return",true);case 16:case"end":return _context2.stop();}}},null,this);}},{key:"resolvedElement",get:function get(){var element=this.domNode;if(this.isParent){if(element.childNodes.length===1){element=element.childNodes[0];}else if(element.childNodes.length<=0){console.log('Child for parent doesnt exist');return null;}}var _element=element,childNodes=_element.childNodes;if(childNodes.length===2){for(var i=0;i<2;i++){var childNode=childNodes[i];if(childNode.tagName==='IMG'){element=childNodes[i?0:i+1];break;}}}return element;}},{key:"resolvedAncestor",get:function get(){return this.ancestorDomNode;}}]);return RNSharedElementNode;}();exports.RNSharedElementNode=RNSharedElementNode;
//# sourceMappingURL=RNSharedElementNode.js.map